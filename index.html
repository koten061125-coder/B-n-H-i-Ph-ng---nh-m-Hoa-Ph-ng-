<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£n ƒê·ªì Du L·ªãch H·∫£i Ph√≤ng (M·ªõi)</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <!-- Turf.js for union -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <!-- osmtogeojson for Overpass data -->
    <script src="https://unpkg.com/osmtogeojson@3.0.0-beta.4/osmtogeojson.min.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        .labelstyle { 
            font-size: 10px; /* Thu nh·ªè font */
            background: rgba(255, 255, 255, 0.9); /* B·∫£ng tr·∫Øng m·ªù */
            border-radius: 2px; 
            padding: 1px 3px; /* Thu nh·ªè padding */
        }
        .emoji-icon { font-size: 20px; } /* K√≠ch th∆∞·ªõc emoji */
        .leaflet-routing-container { width: 320px; } /* T√πy ch·ªânh k√≠ch th∆∞·ªõc routing control */
        #routing-panel { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        #routing-panel.hidden { display: none; }
        #routing-panel label { display: block; margin-bottom: 5px; }
        #routing-panel select { width: 100%; margin-bottom: 10px; }
        #toggle-btn { position: absolute; top: 10px; right: 10px; z-index: 1001; background: white; border: 1px solid #ccc; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="map"></div>
    <button id="toggle-btn">ƒê√≥ng Tra c·ª©u</button>
    <div id="routing-panel">
        <label for="start-select">ƒêi·ªÉm xu·∫•t ph√°t:</label>
        <select id="start-select"></select>
        <label for="end-select">ƒêi·ªÉm ƒë·∫øn:</label>
        <select id="end-select"></select>
    </div>

    <script>
        // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
        var map = L.map('map').setView([20.9, 106.4], 10);

        // Th√™m tile layer kh√¥ng nh√£n
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors & <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // X√≥a t·∫•t c·∫£ marker hi·ªán c√≥ (n·∫øu c√≥)
        map.eachLayer(function(layer) {
            if (layer instanceof L.Marker) {
                map.removeLayer(layer);
            }
        });

        // Danh s√°ch c√°c ƒëi·ªÉm v·ªõi t√™n v√† m√¥ t·∫£ (c·∫≠p nh·∫≠t t·ªça ƒë·ªô m·ªõi)
        var locations = [
            { lat: 20.81917, lng: 106.72472, type: 'airport', name: 'S√¢n bay C√°t Bi', desc: 'S√¢n bay qu·ªëc t·∫ø ch√≠nh c·ªßa H·∫£i Ph√≤ng.' },
            { lat: 20.8560, lng: 106.6875, type: 'train', name: 'Ga H·∫£i Ph√≤ng', desc: 'Ga t√†u ch√≠nh k·∫øt n·ªëi v·ªõi H√† N·ªôi.' },
            { lat: 20.9473, lng: 106.3300, type: 'train', name: 'Ga H·∫£i D∆∞∆°ng', desc: 'Ga t√†u ·ªü trung t√¢m H·∫£i D∆∞∆°ng.' },
            { lat: 20.86806, lng: 106.65676, type: 'bus', name: 'B·∫øn xe Th∆∞·ª£ng L√Ω', desc: 'B·∫øn xe li√™n t·ªânh l·ªõn.' },
            { lat: 20.94657, lng: 106.32947, type: 'bus', name: 'B·∫øn xe H·∫£i D∆∞∆°ng', desc: 'B·∫øn xe ch√≠nh c·ªßa t·ªânh H·∫£i D∆∞∆°ng.' },
            { lat: 20.86481, lng: 106.68345, type: 'port', name: 'B·∫øn c·∫£ng H·∫£i Ph√≤ng', desc: 'C·∫£ng bi·ªÉn l·ªõn nh·∫•t mi·ªÅn B·∫Øc.' },
            { lat: 20.866466746213405, lng: 106.67750247778201, type: 'port', name: 'B·∫øn B√≠nh', desc: 'B·∫øn c·∫£ng container ch√≠nh.' },
            { lat: 20.813206782752374, lng: 106.89523039139442, type: 'port', name: 'B·∫øn ph√† ƒê·ªìng B√†i', desc: 'B·∫øn ph√† h·ªó tr·ª£ ·ªü H·∫£i Ph√≤ng.' },
            { lat: 20.804181327735026, lng: 106.9226162899252, type: 'port', name: 'B·∫øn T√†u Cao T·ªëc C√°i Vi·ªÅng', desc: 'B·∫øn t√†u cao t·ªëc tr√™n ƒë·∫£o C√°t B√†.' },
            { lat: 20.820597614888417, lng: 106.92294802570031, type: 'port', name: 'B·∫øn ph√† C√°i Vi·ªÅng', desc: 'B·∫øn ph√† ch√≠nh tr√™n ƒë·∫£o C√°t B√†.' },
            { lat: 20.8067, lng: 107.0017, type: 'attraction', name: 'ƒê·∫£o C√°t B√†', desc: 'ƒê·∫£o ƒë·∫πp v·ªõi v∆∞·ªùn qu·ªëc gia v√† v·ªãnh.' },
            { lat: 20.795446246858212, lng: 106.99707930449904, type: 'attraction', name: 'V∆∞·ªùn Qu·ªëc gia C√°t B√†', desc: 'V∆∞·ªùn qu·ªëc gia v·ªõi h·ªá sinh th√°i ƒëa d·∫°ng tr√™n ƒë·∫£o C√°t B√†.' },
            { lat: 20.81271836043703, lng: 106.88670652872281, type: 'attraction', name: 'C√°p treo C√°t B√†', desc: 'C√°p treo ng·∫Øm c·∫£nh ƒë·∫£o C√°t B√†.' },
            { lat: 20.7136, lng: 106.7894, type: 'attraction', name: 'B√£i bi·ªÉn ƒê·ªì S∆°n', desc: 'B√£i bi·ªÉn ngh·ªâ d∆∞·ª°ng g·∫ßn th√†nh ph·ªë.' },
            { lat: 20.85741, lng: 106.68180, type: 'attraction', name: 'Nh√† h√°t l·ªõn H·∫£i Ph√≤ng', desc: 'Ki·∫øn tr√∫c Ph√°p c·ªï, bi·ªÉu t∆∞·ª£ng vƒÉn h√≥a.' },
            { lat: 20.84, lng: 106.67, type: 'attraction', name: 'Ch√πa D∆∞ H√†ng', desc: 'Ch√πa c·ªï linh thi√™ng.' },
            { lat: 21.15, lng: 106.3667, type: 'attraction', name: 'Ch√πa C√¥n S∆°n', desc: 'Khu di t√≠ch l·ªãch s·ª≠ v√† t√¢m linh.' },
            { lat: 21.1721, lng: 106.5744, type: 'attraction', name: 'ƒê·ªÅn Ki·∫øp B·∫°c', desc: 'ƒê·ªÅn th·ªù Tr·∫ßn H∆∞ng ƒê·∫°o.' },
            { lat: 20.9861, lng: 106.3, type: 'attraction', name: 'L√†ng g·ªëm Chu ƒê·∫≠u', desc: 'L√†ng ngh·ªÅ g·ªëm truy·ªÅn th·ªëng.' },
            { lat: 20.86023, lng: 106.68823, type: 'hotel', name: 'Pullman Hai Phong Grand Hotel', desc: 'Kh√°ch s·∫°n 5 sao trung t√¢m.' },
            { lat: 20.865, lng: 106.66, type: 'hotel', name: 'Sheraton Hai Phong', desc: 'Kh√°ch s·∫°n cao c·∫•p g·∫ßn Vinhomes.' },
            { lat: 20.84, lng: 106.67, type: 'hotel', name: 'Hotel Nikko Hai Phong', desc: 'Kh√°ch s·∫°n Nh·∫≠t B·∫£n phong c√°ch.' },
            { lat: 20.94, lng: 106.33, type: 'hotel', name: 'Purple Lotus Hotel', desc: 'Kh√°ch s·∫°n 3 sao trung t√¢m.' },
            { lat: 20.94, lng: 106.32, type: 'hotel', name: 'Phuong Anh Hotel', desc: 'Kh√°ch s·∫°n ti·ªán nghi gi√° r·∫ª.' },
            { lat: 20.8600, lng: 106.6880, type: 'restaurant', name: 'Food Connexion', desc: 'Nh√† h√†ng qu·ªëc t·∫ø t·∫°i Pullman, ph·ª•c v·ª• nh√≥m 20+ ng∆∞·ªùi.' },
            { lat: 20.8650, lng: 106.6600, type: 'restaurant', name: 'Harbor Restaurant', desc: 'Nh√† h√†ng buffet t·∫°i Sheraton, s·ª©c ch·ª©a l·ªõn.' },
            { lat: 20.8445, lng: 106.6823, type: 'seafood', name: 'The Three M Restaurant', desc: 'Nh√† h√†ng h·∫£i s·∫£n cao c·∫•p, ph·ª•c v·ª• nh√≥m.' },
            { lat: 20.8500, lng: 106.6700, type: 'seafood', name: 'Ph∆∞∆°ng Nam Restaurant', desc: 'H·∫£i s·∫£n t∆∞∆°i ngon, ph·ª•c v·ª• nh√≥m 20+ ng∆∞·ªùi.' },
            { lat: 20.787587659255458, lng: 106.9814791576015, type: 'resort', name: 'Cat Ba Holiday Retreat', desc: 'Resort ngh·ªâ d∆∞·ª°ng tr√™n ƒë·∫£o C√°t B√†.' },
            { lat: 20.77372812609912, lng: 106.9772501942932, type: 'resort', name: 'Cat Ba Eco Lodge', desc: 'Resort sinh th√°i tr√™n ƒë·∫£o C√°t B√†.' },
            { lat: 20.71955517775071, lng: 107.05656699348432, type: 'resort', name: 'Flamingo Lan H·∫° Bay Resort', desc: 'Resort cao c·∫•p tr√™n ƒë·∫£o C√°t B√†.' },
            { lat: 20.71815444926483, lng: 107.0513154740618, type: 'resort', name: 'The May Legend CatBa Beach Resort & Spa', desc: 'Resort b√£i bi·ªÉn sang tr·ªçng ·ªü C√°t B√†.' },
            { lat: 20.715659803444456, lng: 107.05102677494868, type: 'resort', name: 'Cat Ba Island Resort & Spa', desc: 'Resort ngh·ªâ d∆∞·ª°ng v√† spa ·ªü C√°t B√†.' },
            { lat: 20.678200029246973, lng: 106.81274980971408, type: 'resort', name: 'H√≤n D·∫•u Resort', desc: 'Resort ngh·ªâ d∆∞·ª°ng ƒê·ªì S∆°n ph√π h·ª£p gia ƒë√¨nh.' },
            { lat: 20.680968395663932, lng: 106.81238929320666, type: 'resort', name: 'Tecco ƒê·ªì S∆°n Hotel', desc: 'Kh√°ch s·∫°n ngh·ªâ d∆∞·ª°ng ·ªü ƒê·ªì S∆°n.' },
            { lat: 20.79724405590673, lng: 106.89154960991851, type: 'specialty', name: 'C·ª≠a h√†ng n∆∞·ªõc m·∫Øm C√°t H·∫£i', desc: 'C·ª≠a h√†ng ƒë·∫∑c s·∫£n n∆∞·ªõc m·∫Øm n·ªïi ti·∫øng.' },
            { lat: 20.84566773205937, lng: 106.72091159543274, type: 'specialty', name: 'Ch·∫£ Ch√¨a H·∫° L≈©ng B√°c Ho·∫°t', desc: 'C·ª≠a h√†ng ch·∫£ ch√¨a ƒë·∫∑c s·∫£n H·∫£i Ph√≤ng.' },
            { lat: 20.854942815661307, lng: 106.68940504719494, type: 'specialty', name: 'Vua ƒê·∫∑c S·∫£n t·∫°i H·∫£i Ph√≤ng', desc: 'C·ª≠a h√†ng b√°n ƒë·∫∑c s·∫£n H·∫£i Ph√≤ng.' }
        ];

        // H√†m t·∫°o icon emoji
        function getIcon(type) {
            var emoji;
            switch (type) {
                case 'airport': emoji = '‚úàÔ∏è'; break;
                case 'train': emoji = 'üöÇ'; break;
                case 'bus': emoji = 'üöå'; break;
                case 'port': emoji = '‚öì'; break;
                case 'attraction': emoji = 'üå¥'; break;
                case 'hotel': emoji = 'üè®'; break;
                case 'restaurant': emoji = 'üçΩÔ∏è'; break;
                case 'seafood': emoji = 'üçΩÔ∏è'; break; // D√πng c√πng emoji v·ªõi restaurant
                case 'resort': emoji = 'üèñÔ∏è'; break;
                case 'specialty': emoji = 'üç§'; break; // Emoji t√¥m cho ƒë·∫∑c s·∫£n
                default: emoji = 'üìç'; break;
            }
            return L.divIcon({
                html: `<span class="emoji-icon">${emoji}</span>`,
                className: '',
                iconSize: [24, 24],
                iconAnchor: [12, 24],
                popupAnchor: [0, -24]
            });
        }

        // Th√™m marker v·ªõi icon emoji, tooltip v√† popup
        locations.forEach(function(loc) {
            var marker = L.marker([loc.lat, loc.lng], { icon: getIcon(loc.type) }).addTo(map);
            
            // Hi·ªÉn th·ªã t√™n lu√¥n (tooltip permanent)
            marker.bindTooltip(loc.name, {
                permanent: true,
                direction: 'top',
                offset: [0, -10],
                className: 'labelstyle'
            });
            
            // Popup chi ti·∫øt
            marker.bindPopup('<b>' + loc.name + '</b><br>' + loc.desc);
            
            // Event click: zoom v√† open popup
            marker.on('click', function() {
                map.setView([loc.lat, loc.lng], 15);
                marker.openPopup();
            });
        });

        // T·∫°o routing control v·ªõi profile 'car' (t∆∞∆°ng t·ª± xe kh√°ch n·ªôi th√†nh)
        var routingControl = L.Routing.control({
            waypoints: [
                L.latLng(locations[0].lat, locations[0].lng), // Default start
                L.latLng(locations[1].lat, locations[1].lng)  // Default end
            ],
            routeWhileDragging: true,
            router: L.Routing.osrmv1({ 
                serviceUrl: 'https://router.project-osrm.org/route/v1', 
                profile: 'car'  // Profile 'car' ph√π h·ª£p cho xe kh√°ch n·ªôi th√†nh, ∆∞·ªõc t√≠nh t·ªëc ƒë·ªô trung b√¨nh ~50-60km/h
            }),
            showAlternatives: true,
            lineOptions: { styles: [{ color: 'blue', weight: 4 }] },
            addWaypoints: false  // Kh√¥ng cho ph√©p th√™m waypoint ƒë·ªông
        }).addTo(map);

        // ƒê·ªãnh nghƒ©a nh√£n cho t·ª´ng lo·∫°i
        var typeLabels = {
            'airport': 'S√¢n bay',
            'train': 'Ga t√†u',
            'bus': 'B·∫øn xe',
            'port': 'C·∫£ng/B·∫øn',
            'attraction': 'ƒêi·ªÉm thu h√∫t',
            'hotel': 'Kh√°ch s·∫°n',
            'restaurant': 'Nh√† h√†ng',
            'seafood': 'Nh√† h√†ng h·∫£i s·∫£n',
            'resort': 'Resort',
            'specialty': 'ƒê·∫∑c s·∫£n'
        };

        // Nh√≥m c√°c ƒë·ªãa ƒëi·ªÉm theo type
        var groups = {};
        locations.forEach(function(loc, index) {
            var groupType = loc.type;
            if (!groups[groupType]) {
                groups[groupType] = [];
            }
            groups[groupType].push({index: index, name: loc.name});
        });

        // Th√™m optgroup v√†o select
        var startSelect = document.getElementById('start-select');
        var endSelect = document.getElementById('end-select');
        
        Object.keys(groups).forEach(function(groupType) {
            var optgroup = document.createElement('optgroup');
            optgroup.label = typeLabels[groupType] || groupType;
            
            groups[groupType].forEach(function(item) {
                var option = document.createElement('option');
                option.value = item.index;
                option.text = item.name;
                optgroup.appendChild(option);
            });
            
            startSelect.appendChild(optgroup.cloneNode(true));
            endSelect.appendChild(optgroup);
        });

        // C·∫≠p nh·∫≠t waypoints khi thay ƒë·ªïi select
        function updateRouting() {
            var startIndex = startSelect.value;
            var endIndex = endSelect.value;
            if (startIndex !== '' && endIndex !== '') {
                var startLoc = locations[startIndex];
                var endLoc = locations[endIndex];
                routingControl.setWaypoints([
                    L.latLng(startLoc.lat, startLoc.lng),
                    L.latLng(endLoc.lat, endLoc.lng)
                ]);
            }
        }

        startSelect.addEventListener('change', updateRouting);
        endSelect.addEventListener('change', updateRouting);

        // Toggle panel v√† routing control
        var toggleBtn = document.getElementById('toggle-btn');
        var routingPanel = document.getElementById('routing-panel');
        var isOpen = true;
        toggleBtn.addEventListener('click', function() {
            isOpen = !isOpen;
            if (isOpen) {
                routingPanel.classList.remove('hidden');
                map.addControl(routingControl);
                toggleBtn.textContent = 'ƒê√≥ng Tra c·ª©u';
            } else {
                routingPanel.classList.add('hidden');
                map.removeControl(routingControl);
                toggleBtn.textContent = 'M·ªü Tra c·ª©u';
            }
        });

        // T·∫£i ranh gi·ªõi t·ª´ Overpass Turbo
        var overpassQuery = `
            [out:json];
            area["name"="Vi·ªát Nam"]->.vietnam;
            (
                relation["admin_level"="4"]["name"="H·∫£i Ph√≤ng"](area.vietnam);
                relation["admin_level"="4"]["name"="H·∫£i D∆∞∆°ng"](area.vietnam);
            );
            out geom;
        `;
        fetch('https://overpass-api.de/api/interpreter', {
            method: 'POST',
            body: overpassQuery
        })
            .then(response => response.json())
            .then(data => {
                var haiphongFeature = data.elements.find(e => e.tags.name === 'H·∫£i Ph√≤ng');
                var haiduongFeature = data.elements.find(e => e.tags.name === 'H·∫£i D∆∞∆°ng');
                
                if (haiphongFeature && haiduongFeature) {
                    // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu Overpass sang GeoJSON
                    var haiphongGeoJSON = osmtogeojson({ elements: [haiphongFeature] });
                    var haiduongGeoJSON = osmtogeojson({ elements: [haiduongFeature] });
                    
                    // H·ª£p nh·∫•t ranh gi·ªõi
                    var unionFeature = turf.union(haiphongGeoJSON.features[0], haiduongGeoJSON.features[0]);
                    
                    // Th√™m layer ranh gi·ªõi
                    L.geoJSON(unionFeature, {
                        style: {
                            color: 'black',
                            weight: 5,
                            fillOpacity: 0
                        }
                    }).addTo(map);
                }
            });
    </script>
</body>
</html>
